<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ProyectFinalSantiagoCardozo - Iluminación y Atmósfera</title>

    <style>
        body {
            margin: 0;
            background: #111;
            color: #eee;
            font-family: system-ui, Arial, sans-serif;
        }

        #wrap {
            display: flex;
            gap: 16px;
            padding: 16px;
            align-items: flex-start;
        }

        canvas {
            border: 1px solid #444;
            background: #000;
        }

        #panel {
            max-width: 460px;
            line-height: 1.4;
        }

        .mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
        }

        .hint {
            color: #bbb;
            font-size: 14px;
        }

        ul {
            margin-top: 6px;
        }
    </style>
</head>

<body>
    <div id="wrap">
        <div>
            <canvas id="glcanvas" width="620" height="620"></canvas>
            <div id="hud" class="mono hint"></div>
        </div>

        <div id="panel">
            <h2>Proyecto Final - Iluminación avanzada + atmósfera</h2>
            <p>
                Mini diorama 3D para comparar Gouraud, Phong y Blinn-Phong, con spotlight, fog y toon.
                Incluye cámara orbital y traslación por ejes.
            </p>

            <h3>Controles</h3>
            <ul class="mono">
                <li>1 → Gouraud</li>
                <li>2 → Phong (fragment)</li>
                <li>3 → Blinn-Phong (fragment)</li>
                <li>4 → Spotlight ON / OFF</li>
                <li>5 → Fog ON / OFF</li>
                <li>6 → Toon ON / OFF</li>
                <li>P → Perspectiva / Ortográfica</li>
                <li>Ratón (arrastrar) → Orbitar</li>
                <li>Rueda → Zoom</li>
                <li>W/S/A/D → mover cámara en X/Z</li>
                <li>Q/E → subir/bajar (Y)</li>
                <li>Shift + WASD/QE → movimiento más rápido</li>
            </ul>

            <p class="hint">
                Nota: Para la demo, la diferencia entre Phong (2) y Blinn (3) está exagerada en el especular
                (shininess distinto) para que se aprecie claramente.
            </p>
        </div>
    </div>

    <!-- =========================================================
         SHADER: GOURAUD (iluminación en VERTEX)
         ========================================================= -->
    <script id="vs_gouraud" type="x-shader/x-vertex">
        attribute vec3 aPos;
        attribute vec3 aNor;

        uniform mat4 uModel, uView, uProj;
        uniform mat3 uNormalMat;

        uniform vec3 uLightPos, uLa, uLd, uLs;
        uniform vec3 uKa, uKd, uKs;
        uniform float uAlpha;

        uniform bool uUseSpot;
        uniform vec3 uSpotDir;     // en eye coords
        uniform float uCutoffDeg;
        uniform float uSpotExp;

        uniform float uKc, uKl, uKq;

        varying vec3 vColor;

        void main(){
          vec4 ecPos4 = uView * uModel * vec4(aPos, 1.0);
          vec3 ecPos  = ecPos4.xyz;

          vec3 N = normalize(uNormalMat * aNor);
          vec3 S = normalize(uLightPos - ecPos);
          vec3 V = normalize(-ecPos);
          vec3 R = reflect(-S, N);

          float spot = 1.0;
          if(uUseSpot){
            float cosA = dot(-S, normalize(uSpotDir));
            float cutoff = cos(radians(uCutoffDeg));
            spot = (cosA > cutoff) ? pow(max(cosA,0.0), uSpotExp) : 0.0;
          }

          float d = length(uLightPos - ecPos);
          float att = 1.0 / (uKc + uKl*d + uKq*d*d);

          vec3 ambient = uKa * uLa;

          float NdotL = max(dot(N, S), 0.0);
          vec3 diffuse = (uKd * uLd) * NdotL;

          float spec = 0.0;
          if(NdotL > 0.0){
            spec = pow(max(dot(R, V), 0.0), uAlpha);
          }
          vec3 specular = (uKs * uLs) * spec;

          vColor = ambient + (diffuse + specular) * spot * att;
          gl_Position = uProj * ecPos4;
        }
    </script>

    <script id="fs_gouraud" type="x-shader/x-fragment">
        precision mediump float;
        varying vec3 vColor;
        void main(){
          gl_FragColor = vec4(vColor, 1.0);
        }
    </script>

    <!-- =========================================================
         SHADER: PHONG / BLINN / TOON + FOG (FRAGMENT)
         - shininess distinto (exagerado) para demo
         - fog con distancia a cámara (length(vPosEC))
         ========================================================= -->
    <script id="vs_lit" type="x-shader/x-vertex">
        attribute vec3 aPos;
        attribute vec3 aNor;

        uniform mat4 uModel, uView, uProj;
        uniform mat3 uNormalMat;

        varying vec3 vPosEC;
        varying vec3 vNorEC;

        void main(){
          vec4 ecPos4 = uView * uModel * vec4(aPos, 1.0);
          vPosEC = ecPos4.xyz;
          vNorEC = normalize(uNormalMat * aNor);
          gl_Position = uProj * ecPos4;
        }
    </script>

    <script id="fs_lit" type="x-shader/x-fragment">
        precision mediump float;

        varying vec3 vPosEC;
        varying vec3 vNorEC;

        uniform int uSpecModel;   // 0 = Phong | 1 = Blinn-Phong

        // Luz
        uniform vec3 uLightPos;   // eye coords
        uniform vec3 uLa, uLd, uLs;

        // Material
        uniform vec3 uKa, uKd, uKs;
        uniform float uAlpha;

        // Spotlight
        uniform bool uUseSpot;
        uniform vec3 uSpotDir;    // eye coords
        uniform float uCutoffDeg;
        uniform float uSpotExp;

        // Atenuación
        uniform float uKc, uKl, uKq;

        // Toon
        uniform bool uUseToon;

        // Fog
        uniform bool uUseFog;
        uniform vec3 uFogColor;
        uniform float uFogStart;
        uniform float uFogEnd;

        void main() {
          vec3 N = normalize(vNorEC);
          vec3 S = normalize(uLightPos - vPosEC);
          vec3 V = normalize(-vPosEC);

          // Spotlight
          float spot = 1.0;
          if(uUseSpot){
            float cosA = dot(-S, normalize(uSpotDir));
            float cutoff = cos(radians(uCutoffDeg));
            spot = (cosA > cutoff) ? pow(max(cosA,0.0), uSpotExp) : 0.0;
          }

          // Atenuación
          float dL = length(uLightPos - vPosEC);
          float att = 1.0 / (uKc + uKl*dL + uKq*dL*dL);

          // Base
          vec3 ambient = uKa * uLa;
          float NdotL = max(dot(N, S), 0.0);
          vec3 diffuse = uKd * uLd * NdotL;

          // Especular (DEMO EXAGERADA)
          float spec = 0.0;
          if(NdotL > 0.0){
            if(uSpecModel == 0){
              // PHONG: brillo más concentrado
              vec3 R = reflect(-S, N);
              float phongExp = uAlpha * 1.6;
              spec = pow(max(dot(R, V), 0.0), phongExp);
            } else {
              // BLINN: brillo más ancho
              vec3 H = normalize(S + V);
              float blinnExp = max(uAlpha * 0.35, 4.0);
              spec = pow(max(dot(N, H), 0.0), blinnExp);
            }
          }

          vec3 specCol = uKs * uLs * spec;
          if(uSpecModel == 1){
            // tinte ligero para distinguir en demo
            specCol *= vec3(0.7, 0.85, 1.2);
          }

          vec3 color = ambient + (diffuse + specCol) * spot * att;

          // Toon (cuantiza difusa)
          if(uUseToon){
            float levels = 4.0;
            float q = floor(NdotL * levels) / (levels - 1.0);
            color = ambient + q * uKd * uLd * spot * att;
          }

          // Fog con distancia a cámara (eye coords)
          if(uUseFog){
            float dCam = length(vPosEC);
            float f = clamp((uFogEnd - dCam) / (uFogEnd - uFogStart), 0.0, 1.0);
            color = mix(uFogColor, color, f);
          }

          gl_FragColor = vec4(color, 1.0);
        }
    </script>

    <script src="ProyectFinalSantiagoCardozo.js"></script>
</body>
</html>
